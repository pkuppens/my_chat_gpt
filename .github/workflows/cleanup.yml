---
name: Repository Cleanup

# Trigger this workflow after successful merge to main
# This ensures cleanup only runs after CI/CD passes
on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

# Permissions needed for cleanup operations
permissions:
  contents: write  # For deleting branches
  actions: write   # For deleting workflow runs

jobs:
  cleanup:
    name: Clean up merged branches and old workflow runs
    runs-on: ubuntu-latest

    # Only run after other workflows succeed
    # This prevents cleanup if tests/builds fail
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for branch analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email \
            "github-actions[bot]@users.noreply.github.com"

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth refresh --scopes workflow

      - name: Clean up merged branches
        run: |
          echo "::group::Branch Cleanup"
          bash scripts/cleanup-merged-branches.sh --execute
          echo "::endgroup::"

      - name: Clean up old workflow runs
        run: |
          echo "::group::Workflow Run Cleanup"
          bash scripts/cleanup-github-actions.sh --execute
          echo "::endgroup::"

      - name: Summary
        run: |
          echo "### Cleanup Complete :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Merged branches deleted" >> $GITHUB_STEP_SUMMARY
          echo "- Old workflow runs cleaned" >> $GITHUB_STEP_SUMMARY
          echo "- Failed runs kept for debugging" >> $GITHUB_STEP_SUMMARY
